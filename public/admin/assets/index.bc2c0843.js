import{h as E,au as o,R as I,r as c,j as e,B as h,a as C,F,ae as p,H as k,M as L,ab as _,bc as S}from"./index.c9120cbf.js";import{T}from"./index.ee813a36.js";import{C as D}from"./index.5ea7e2d9.js";import{D as N,A as v,P as R}from"./index.fc1c965c.js";import{i as P,C as O,D as J}from"./use-immer.module.389db103.js";import{I as W,S as q}from"./index.a8e0aad5.js";import"./index.4188f90c.js";import{c as M}from"./convertNullToUndefined.a19d8223.js";import{f as j}from"./formatDate.c584a859.js";import{a as z}from"./index.ac55783b.js";import{I as H}from"./index.ce3545d1.js";import"./index.68543289.js";function V(t){return E.post("/api/leads/query",t)}function Z(t){return E.post("/api/leads/detail",t)}function $(t){return E.post("/api/leads/create",t)}function G(t){return E.post("/api/leads/update",t)}function K(t){return E.post("/api/leads/delete",t)}function U(){return E.post("/api/leads/group/query")}function Q(){return E.post("/api/leads/status/query")}const X=o.Item,A=I.createContext({});function Y(t){const{children:u,record:d,className:m,...i}=t,n=c.exports.useRef(null),a=()=>n.current;return e(A.Provider,{value:{getForm:a},children:e(o,{style:{display:"table-row"},children:u,ref:n,wrapper:"tr",wrapperProps:i})})}function ee(t){const{children:u,className:d,rowData:m,column:i,onHandleSave:n}=t,a=c.exports.useRef(null),l=c.exports.useRef(null),{getForm:r}=c.exports.useContext(A),[s,f]=c.exports.useState(!1),g=c.exports.useCallback(y=>{s&&i.editable&&a.current&&!a.current.contains(y.target)&&!y.target.classList.contains("js-demo-select-option")&&x(m[i.dataIndex])},[s,m,i]);c.exports.useEffect(()=>{s&&l.current&&l.current.focus()},[s]),c.exports.useEffect(()=>(document.addEventListener("click",g,!0),()=>{document.removeEventListener("click",g,!0)}),[g]);const x=y=>{r().validate([i.dataIndex],(B,w)=>{(!B||!B[i.dataIndex])&&(f(!s),n&&n({...m,...w}))})};return s?e("div",{ref:a,children:e(X,{style:{marginBottom:0},labelCol:{span:0},wrapperCol:{span:24},initialValue:m[i.dataIndex],field:i.dataIndex,rules:[{required:i.dataIndex==="name"}],children:e(p,{ref:l,onPressEnter:x})})}):e("div",{className:i.editable?`editable-cell ${d}`:d,onClick:()=>{i.editable&&f(!s)},children:u||"-"})}function te(t){const[u,d]=c.exports.useState([]);function m(a){const l=[...u],r=l.findIndex(s=>a.key===s.key);l.splice(r,1,{...l[r],...a}),d(l)}function i(){d([...u].concat({key:Math.random()*1e3,name:"\u8BF7\u6DFB\u52A0\u4EBA\u5458",phone:""}))}const n=I.useMemo(()=>{const a=[...t.columns];return a.some(l=>l.dataIndex==="option")||a.push({title:"\u64CD\u4F5C",dataIndex:"option",render:(l,r)=>e(h,{onClick:()=>{d(s=>s.filter(f=>f.key!==r.key))},type:"primary",status:"danger",children:"\u5220\u9664"})}),a},[u]);return c.exports.useEffect(()=>{!u.length&&t.data&&t.data.length&&d(t.data.map(a=>({...a,key:a.key?a.key:Math.random()*1e3})))},[t.data]),c.exports.useEffect(()=>{t.onChange(u)},[u]),C(F,{children:[e(h,{style:{marginBottom:10},type:"primary",onClick:i,children:"\u6DFB\u52A0"}),e(z,{rowKey:"name",pagination:!1,data:u,components:{body:{row:Y,cell:ee}},columns:n.map(a=>a.editable?{...a,onCell:()=>({onHandleSave:m})}:a)})]})}const ae=p.TextArea,{Option:b}=v;function re(t){var a,l;const[u]=o.useForm(),[d,m]=c.exports.useState(!1),i=[{title:"\u540D\u5B57",dataIndex:"name",editable:!0},{title:"\u7535\u8BDD",dataIndex:"phone",editable:!0},{title:"\u90AE\u7BB1",dataIndex:"email",editable:!0}];async function n(){u.validate().then(async r=>{m(!0);try{const s=r.additional_contacts.flatMap(x=>x.name==="\u8BF7\u6DFB\u52A0\u4EBA\u5458"?[]:{name:x.name,phone:x.phone,email:x.email}),f={...r,tags:JSON.stringify(r.tags),additional_contacts:JSON.stringify(s)};let g;t.data?g=await G({...f,uuid:t.data.uuid}):g=await $(f),g.code===0&&(t.reload(),t.close())}finally{m(!1)}}).catch(r=>{if(r.errors)for(const s in r.errors)L.error(r.errors[s].message)})}return c.exports.useEffect(()=>{if(t.data){const r=M(t.data);u.setFieldsValue({...r,assigned_at:r.assigned_at?j(new Date(r.assigned_at)):void 0,tags:r.tags&&Array.isArray(JSON.parse(r.tags))?JSON.parse(r.tags):[],additional_contacts:r.additional_contacts&&Array.isArray(JSON.parse(r.additional_contacts))?JSON.parse(r.additional_contacts):[]})}},[t.data]),c.exports.useEffect(()=>{t.visible===!1&&u.resetFields()},[u,t.visible]),e(D,{title:t.data?"\u4FEE\u6539\u7EBF\u7D22":"\u521B\u5EFA\u7EBF\u7D22",extra:e(k,{style:{cursor:"point",color:"#333",fontSize:"16px"},onClick:()=>t.close()}),actions:[e(h,{type:"default",onClick:()=>t.close(),children:"\u53D6\u6D88"},"cancel"),e(h,{type:"primary",loading:d,onClick:n,children:t.data?"\u4FDD\u5B58":"\u521B\u5EFA"},"submit")],children:C(o,{form:u,labelCol:{span:2},wrapperCol:{span:8},children:[e(o.Item,{label:"\u516C\u53F8",field:"company",children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u516C\u53F8"})}),e(o.Item,{label:"\u540D\u5B57",field:"name",children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u540D\u5B57"})}),e(o.Item,{label:"\u624B\u673A\u53F7",field:"phone",children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u624B\u673A\u53F7"})}),e(o.Item,{label:"\u90AE\u7BB1",field:"email",rules:[{validator(r,s){r&&!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(r)&&s("\u90AE\u7BB1\u683C\u5F0F\u4E0D\u6B63\u786E")}}],children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u90AE\u7BB1"})}),e(o.Item,{label:"\u8D1F\u8D23\u4EBA",field:"assigned_to",children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u5206\u914D\u4EBA"})}),e(o.Item,{label:"\u5206\u914D\u65F6\u95F4",field:"assigned_at",disabled:!0,wrapperCol:{span:2},children:e(N,{})}),e(o.Item,{label:"\u6765\u6E90",field:"source",children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u6765\u6E90"})}),e(o.Item,{label:"\u6807\u7B7E",field:"tags",children:e(W,{allowClear:!0,placeholder:"\u8BF7\u8F93\u5165\u6807\u7B7E\u5E76\u4E14\u56DE\u8F66\u786E\u8BA4"})}),e(o.Item,{label:"\u6CE8\u518C\u5165\u53E3",field:"registration_entry",children:e(p,{maxLength:100,showWordLimit:!0,placeholder:"\u6CE8\u518C\u5165\u53E3"})}),e(o.Item,{label:"\u5206\u7EC4",field:"group",wrapperCol:{span:2},children:e(v,{placeholder:"\u9009\u62E9\u5206\u7EC4",children:(a=t.group)==null?void 0:a.map(r=>e(b,{value:r,children:r},r))})}),e(o.Item,{label:"\u72B6\u6001",field:"status",wrapperCol:{span:2},children:e(q,{placeholder:"\u9009\u62E9\u72B6\u6001",allowClear:!0,children:(l=t.status)==null?void 0:l.map(r=>e(b,{value:r,children:r},r))})}),e(o.Item,{label:"\u9644\u52A0\u8054\u7CFB\u65B9\u5F0F",field:"additional_contacts",triggerPropName:"data",children:e(te,{columns:i})}),e(o.Item,{label:"\u5907\u6CE8",field:"description",children:e(ae,{maxLength:200,placeholder:"\u5907\u6CE8",showWordLimit:!0,autoSize:!0,style:{minHeight:64}})})]})})}function xe(){const t=c.exports.useRef(),[u,d]=P({visible:!1,close:function(){d(n=>{n.visible=!1})},group:[],status:[]});c.exports.useEffect(()=>{U().then(n=>{n.code===0&&d(a=>{a.group=n.data||[]})}),Q().then(n=>{n.code===0&&d(a=>{a.status=n.data||[]})})},[]);async function m(n){try{const a=await Z({uuid:n});a.code===0&&d(l=>{l.data=a.data,l.visible=!0})}catch{}}const i=[{title:"\u5173\u952E\u8BCD",dataIndex:"keyword",search:!0,hide:!0},{title:"ID",dataIndex:"id",width:80,sorter:!0,search:!0,valueType:"number",fieldProps:{min:0,precision:0}},{title:"\u516C\u53F8",dataIndex:"company",ellipsis:!0,sorter:!0,search:!0},{title:"\u540D\u5B57",dataIndex:"name",sorter:!0,search:!0},{title:"\u624B\u673A",dataIndex:"phone",sorter:!0,search:!0},{title:"\u90AE\u7BB1",dataIndex:"email",sorter:!0,search:!0},{title:"\u8D1F\u8D23\u4EBA",dataIndex:"assigned_to",sorter:!0,search:!0},{title:"\u72B6\u6001",dataIndex:"status",sorter:!0,search:!0,valueType:"select",fieldProps:{options:u.status.map(n=>({label:n,value:n}))}},{title:"\u5206\u914D\u65F6\u95F4",dataIndex:"assigned_at",sorter:!0,search:!0,valueType:"date"},{title:"\u6765\u6E90",dataIndex:"source",sorter:!0,search:!0},{title:"\u6CE8\u518C\u6761\u76EE",dataIndex:"registration_entry",sorter:!0,search:!0},{title:"\u6807\u7B7E",dataIndex:"tags",render(n,a){if(a.tags&&typeof JSON.parse(a.tags)=="object")return e(_,{children:JSON.parse(a.tags).map(l=>e(T,{children:l},l))})}},{title:"\u5206\u7EC4",dataIndex:"group",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:u.group}},{title:"\u521B\u5EFA\u65F6\u95F4",dataIndex:"updated_at",sorter:!0,search:!0,valueType:"date"},{title:"\u64CD\u4F5C",width:280,fixed:"right",render:(n,a)=>C(O,{children:[C(h,{type:"text",onClick:()=>m(a.uuid),children:[e(S,{}),"\u7F16\u8F91"]}),e(J,{reqDel:K,params:{uuid:a.uuid},reload:()=>t.current.reload(),children:C(h,{type:"text",children:[e(H,{}),"\u5220\u9664"]})})]})}];return C(F,{children:[u.visible&&e(re,{visible:u.visible,data:u.data,close:()=>u.close(),reload:()=>t.current.reload(),group:u.group,status:u.status}),e(D,{style:{display:u.visible?"none":void 0},children:e(R,{ref:t,request:V,columns:i,scroll:{x:2500},actionBarRender:[e(h,{type:"primary",onClick:()=>t.current.reload(),children:"\u5237\u65B0"},"refresh")],toolBarRender:[e(h,{type:"primary",onClick:()=>{d(n=>{n.visible=!0,n.data=void 0})},children:"\u521B\u5EFA\u7EBF\u7D22"},"create")]})})]})}export{xe as default};
