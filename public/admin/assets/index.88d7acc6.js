import{h as x,au as o,R as I,r as d,j as e,B as f,a as y,F as D,ae as g,H as k,M as _,bf as L,ab as S,bc as T}from"./index.2132e63f.js";import{T as N}from"./index.2ede2469.js";import{C as v}from"./index.dbf9034b.js";import{A as F,D as R,P}from"./index.87299b9b.js";import{i as O,C as q,D as J}from"./use-immer.module.0a632639.js";import{I as M}from"./index.336a555d.js";import"./index.3a804c5b.js";import{c as W}from"./convertNullToUndefined.a19d8223.js";import{f as H}from"./formatDate.c584a859.js";import{a as j}from"./index.a71fd27e.js";import{I as z}from"./index.a07cbbc8.js";import{I as V}from"./index.87707fcb.js";import"./index.853d7a04.js";function Z(r){return x.post("/api/leads/query",r)}function U(r){return x.post("/api/leads/detail",r)}function $(r){return x.post("/api/leads/create",r)}function G(r){return x.post("/api/leads/update",r)}function K(r){return x.post("/api/leads/delete",r)}function Q(){return x.post("/api/leads/group/query")}function X(){return x.post("/api/leads/status/query")}function Y(){return x.post("/api/leads/assigner/query")}const ee=o.Item,w=I.createContext({});function te(r){const{children:i,record:n,className:l,...s}=r,p=d.exports.useRef(null),t=()=>p.current;return e(w.Provider,{value:{getForm:t},children:e(o,{style:{display:"table-row"},children:i,ref:p,wrapper:"tr",wrapperProps:s})})}function ae(r){const{children:i,className:n,rowData:l,column:s,onHandleSave:p}=r,t=d.exports.useRef(null),u=d.exports.useRef(null),{getForm:c}=d.exports.useContext(w),[a,m]=d.exports.useState(!1),E=d.exports.useCallback(h=>{a&&s.editable&&t.current&&!t.current.contains(h.target)&&!h.target.classList.contains("js-demo-select-option")&&C(l[s.dataIndex])},[a,l,s]);d.exports.useEffect(()=>{a&&u.current&&u.current.focus()},[a]),d.exports.useEffect(()=>(document.addEventListener("click",E,!0),()=>{document.removeEventListener("click",E,!0)}),[E]);const C=h=>{c().validate([s.dataIndex],(b,A)=>{(!b||!b[s.dataIndex])&&(m(!a),p&&p({...l,...A}))})};return a?e("div",{ref:t,children:e(ee,{style:{marginBottom:0},labelCol:{span:0},wrapperCol:{span:24},initialValue:l[s.dataIndex],field:s.dataIndex,rules:[{required:s.dataIndex==="name",message:s.dataIndex==="name"?"\u540D\u5B57\u662F\u5FC5\u586B\u9879":void 0}],children:e(g,{ref:u,onPressEnter:C})})}):e("div",{className:s.editable?`editable-cell ${n}`:n,onClick:()=>{s.editable&&m(!a)},children:i||"-"})}function re(r){const[i,n]=d.exports.useState([]);function l(t){const u=[...i],c=u.findIndex(a=>t.key===a.key);u.splice(c,1,{...u[c],...t}),n(u)}function s(){n([...i].concat({key:Math.random()*1e3,name:"",phone:""}))}const p=I.useMemo(()=>{const t=[...r.columns];return t.some(u=>u.dataIndex==="option")||t.push({title:"\u64CD\u4F5C",dataIndex:"option",render:(u,c)=>e(f,{onClick:()=>{n(a=>a.filter(m=>m.key!==c.key))},type:"primary",status:"danger",children:"\u5220\u9664"})}),t},[i]);return d.exports.useEffect(()=>{!i.length&&r.data&&r.data.length&&n(r.data.map(t=>({...t,key:t.key?t.key:Math.random()*1e3})))},[r.data]),d.exports.useEffect(()=>{r.onChange(i)},[i]),y(D,{children:[e(f,{style:{marginBottom:10},type:"primary",onClick:s,children:"\u6DFB\u52A0"}),e(j,{rowKey:"name",pagination:!1,data:i,components:{body:{row:te,cell:ae}},columns:p.map(t=>t.editable?{...t,onCell:()=>({onHandleSave:l})}:t)})]})}const ue=g.TextArea,{Option:B}=F;function ne(r){var t,u,c;const[i]=o.useForm(),[n,l]=d.exports.useState(!1),s=[{title:"\u540D\u5B57",dataIndex:"name",editable:!0},{title:"\u7535\u8BDD",dataIndex:"phone",editable:!0},{title:"\u5FAE\u4FE1",dataIndex:"wechat",editable:!0},{title:"\u90AE\u7BB1",dataIndex:"email",editable:!0}];async function p(){i.validate().then(async a=>{l(!0);try{const m=a.additional_contacts.flatMap(h=>h.name===""?[]:{name:h.name,phone:h.phone,wechat:h.wechat,email:h.email}),E={...a,tags:JSON.stringify(a.tags),additional_contacts:JSON.stringify(m)};let C;r.data?C=await G({...E,uuid:r.data.uuid}):C=await $(E),C.code===0&&(r.reload(),r.close())}finally{l(!1)}}).catch(a=>{if(a.errors)for(const m in a.errors)_.error(a.errors[m].message)})}return d.exports.useEffect(()=>{if(r.data){const a=W(r.data);i.setFieldsValue({...a,assigned_at:a.assigned_at?H(new Date(a.assigned_at)):void 0,tags:a.tags&&Array.isArray(JSON.parse(a.tags))?JSON.parse(a.tags):[],additional_contacts:a.additional_contacts&&Array.isArray(JSON.parse(a.additional_contacts))?JSON.parse(a.additional_contacts):[]})}},[r.data]),d.exports.useEffect(()=>{r.visible===!1&&i.resetFields()},[i,r.visible]),e(v,{title:r.data?"\u4FEE\u6539\u7EBF\u7D22":"\u521B\u5EFA\u7EBF\u7D22",extra:e(k,{style:{cursor:"point",color:"#333",fontSize:"16px"},onClick:()=>r.close()}),actions:[e(f,{type:"default",onClick:()=>r.close(),children:"\u53D6\u6D88"},"cancel"),e(f,{type:"primary",loading:n,onClick:p,children:r.data?"\u4FDD\u5B58":"\u521B\u5EFA"},"submit")],children:y(o,{form:i,labelCol:{span:2},wrapperCol:{span:8},children:[e(o.Item,{label:"\u516C\u53F8\u540D\u79F0",field:"company",children:e(g,{maxLength:100,showWordLimit:!0,placeholder:"\u516C\u53F8\u540D\u79F0"})}),e(o.Item,{label:"\u5BA2\u6237\u59D3\u540D",field:"name",children:e(g,{maxLength:100,showWordLimit:!0,placeholder:"\u5BA2\u6237\u540D\u5B57"})}),e(o.Item,{label:"\u624B\u673A\u53F7",field:"phone",children:e(g,{maxLength:100,showWordLimit:!0,placeholder:"\u624B\u673A\u53F7"})}),e(o.Item,{label:"\u90AE\u7BB1",field:"email",rules:[{validator(a,m){a&&!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(a)&&m("\u90AE\u7BB1\u683C\u5F0F\u4E0D\u6B63\u786E")}}],children:e(g,{maxLength:100,showWordLimit:!0,placeholder:"\u90AE\u7BB1"})}),e(o.Item,{label:"\u8D1F\u8D23\u4EBA",field:"assigned_to",children:e(F,{placeholder:"\u8BBE\u7F6E\u8D1F\u8D23\u4EBA",children:(t=r.assigner)==null?void 0:t.map(a=>e(B,{value:a,children:a},a))})}),e(o.Item,{label:"\u5206\u914D\u65F6\u95F4",field:"assigned_at",disabled:!0,wrapperCol:{span:2},children:e(R,{})}),e(o.Item,{label:"\u6765\u6E90",field:"source",disabled:!0,children:e(g,{maxLength:100,showWordLimit:!0,placeholder:"\u6765\u6E90"})}),e(o.Item,{label:"\u6807\u7B7E",field:"tags",children:e(M,{allowClear:!0,placeholder:"\u8BF7\u8F93\u5165\u6807\u7B7E\u5E76\u4E14\u56DE\u8F66\u786E\u8BA4"})}),e(o.Item,{label:"\u6CE8\u518C\u5165\u53E3",field:"registration_entry",disabled:!0,children:e(g,{maxLength:100,showWordLimit:!0,placeholder:"\u6CE8\u518C\u5165\u53E3"})}),e(o.Item,{label:"\u5206\u7EC4",field:"group",wrapperCol:{span:2},children:e(F,{placeholder:"\u8BBE\u7F6E\u5206\u7EC4",children:(u=r.group)==null?void 0:u.map(a=>e(B,{value:a,children:a},a))})}),e(o.Item,{label:"\u72B6\u6001",field:"status",wrapperCol:{span:2},children:e(F,{placeholder:"\u8BBE\u7F6E\u72B6\u6001",children:(c=r.status)==null?void 0:c.map(a=>e(B,{value:a,children:a},a))})}),e(o.Item,{label:"\u9644\u52A0\u8054\u7CFB\u65B9\u5F0F",field:"additional_contacts",triggerPropName:"data",wrapperCol:{span:22},children:e(re,{columns:s})}),e(o.Item,{label:"\u5907\u6CE8",field:"description",wrapperCol:{span:22},children:e(ue,{maxLength:200,placeholder:"\u5907\u6CE8",showWordLimit:!0,autoSize:!0,style:{minHeight:100}})})]})})}function Ce(){const r=L(),i=d.exports.useRef(),[n,l]=O({visible:!1,close:function(){l(t=>{t.visible=!1})},group:[],status:[],assigner:[]});d.exports.useEffect(()=>{n.visible||(Q().then(t=>{t.code===0&&l(u=>{u.group=t.data||[]})}),X().then(t=>{t.code===0&&l(u=>{u.status=t.data||[]})}),Y().then(t=>{t.code===0&&l(u=>{u.assigner=t.data||[]})}))},[n.visible]);async function s(t){try{const u=await U({uuid:t});u.code===0&&l(c=>{c.data=u.data,c.visible=!0})}catch{}}const p=[{title:"ID",width:80,dataIndex:"id",sorter:!0},{title:"\u516C\u53F8\u540D\u79F0",dataIndex:"company",ellipsis:!0,sorter:!0,search:!0},{title:"\u5BA2\u6237\u59D3\u540D",dataIndex:"name",sorter:!0,copy:!0},{title:"\u624B\u673A",dataIndex:"phone",sorter:!0,copy:!0},{title:"\u90AE\u7BB1",width:200,dataIndex:"email",sorter:!0,copy:!0},{title:"\u5206\u7EC4",dataIndex:"group",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:n.group}},{title:"\u8D1F\u8D23\u4EBA",dataIndex:"assigned_to",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:n.assigner}},{title:"\u5206\u914D\u65F6\u95F4",dataIndex:"assigned_at",sorter:!0},{title:"\u72B6\u6001",dataIndex:"status",sorter:!0,search:!0,valueType:"select",fieldProps:{options:n.status.map(t=>({label:t,value:t}))}},{title:"\u6765\u6E90",dataIndex:"source",sorter:!0,search:!0},{title:"\u6CE8\u518C\u5165\u53E3",dataIndex:"registration_entry",sorter:!0,search:!0},{title:"\u6807\u7B7E",dataIndex:"tags",render(t,u){if(u.tags&&typeof JSON.parse(u.tags)=="object")return e(S,{children:JSON.parse(u.tags).map(c=>e(N,{children:c},c))})}},{title:"\u5206\u914D\u65F6\u95F4",dataIndex:"assignedStartTime,assignedEndTime",search:!0,valueType:"date",hide:!0},{title:"\u521B\u5EFA\u65F6\u95F4",width:200,dataIndex:"updated_at",sorter:!0},{title:"\u521B\u5EFA\u65F6\u95F4",dataIndex:"startTime,endTime",search:!0,valueType:"date",hide:!0},{title:"\u5173\u952E\u8BCD",dataIndex:"keyword",search:!0,hide:!0},{title:"\u64CD\u4F5C",width:280,fixed:"right",render:(t,u)=>y(q,{children:[y(f,{type:"text",onClick:()=>s(u.uuid),children:[e(T,{}),"\u7F16\u8F91"]}),y(f,{type:"text",onClick:()=>{r.push({pathname:"/marketManage/message",search:new URLSearchParams({name:u.name,phone:u.phone,email:u.email}).toString()})},children:[e(z,{}),"\u6D88\u606F"]}),e(J,{reqDel:K,params:{uuid:u.uuid},reload:()=>i.current.reload(),children:y(f,{type:"text",children:[e(V,{}),"\u5220\u9664"]})})]})}];return y(D,{children:[n.visible&&e(ne,{visible:n.visible,data:n.data,close:()=>n.close(),reload:()=>i.current.reload(),group:n.group,status:n.status,assigner:n.assigner}),e(v,{style:{display:n.visible?"none":void 0},children:e(P,{ref:i,request:Z,columns:p,scroll:{x:2500},actionBarRender:[e(f,{type:"primary",onClick:()=>i.current.reload(),children:"\u5237\u65B0"},"refresh")],toolBarRender:[e(f,{type:"primary",onClick:()=>{l(t=>{t.visible=!0,t.data=void 0})},children:"\u521B\u5EFA\u7EBF\u7D22"},"create")]})})]})}export{Ce as default};
